{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ScriptComponent = void 0;\nconst script_messages_1 = require(\"./script-messages\");\nconst interfaces_1 = require(\"../utilities/interfaces\");\nconst _constants = require(\"../utilities/constants-angular\");\nconst rxjs_1 = require(\"rxjs\");\nconst i0 = require(\"@angular/core\");\nconst i1 = require(\"../workspace/workspace-service\");\nconst i2 = require(\"../database/database-service\");\nconst i3 = require(\"./script-service\");\nconst i4 = require(\"../schedule/schedule-service\");\nconst i5 = require(\"ngx-electronyzer\");\nconst i6 = require(\"../utilities/utilities\");\nconst i7 = require(\"@angular/common\");\nconst i8 = require(\"@angular/forms\");\nconst i9 = require(\"@po-ui/ng-components\");\nconst _c0 = [\"modal_1\"];\nconst _c1 = [\"modal_2\"];\nfunction ScriptComponent_div_4_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 19)(1, \"span\");\n    i0.ɵɵtext(2, \"Nenhum agendamento encontrado\");\n    i0.ɵɵelementEnd()();\n  }\n}\nfunction ScriptComponent_po_list_view_6_ng_template_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 1);\n    i0.ɵɵelement(1, \"po-table\", 22);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const item_r7 = ctx.$implicit;\n    const ctx_r6 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"p-actions\", ctx_r6.setTableRowActions)(\"p-columns\", ctx_r6.setcolumns)(\"p-items\", item_r7.scripts)(\"p-actions-right\", true);\n  }\n}\nfunction ScriptComponent_po_list_view_6_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"po-list-view\", 20);\n    i0.ɵɵtemplate(1, ScriptComponent_po_list_view_6_ng_template_1_Template, 2, 4, \"ng-template\", 21);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵproperty(\"p-items\", ctx_r1.schedulesScript)(\"p-actions\", ctx_r1.setListViewActions);\n  }\n}\nfunction ScriptComponent_po_list_view_7_ng_template_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 1);\n    i0.ɵɵelement(1, \"po-table\", 22);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const item_r9 = ctx.$implicit;\n    const ctx_r8 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"p-actions\", ctx_r8.setTableRowActions)(\"p-columns\", ctx_r8.setcolumns)(\"p-items\", item_r9.scripts)(\"p-actions-right\", true);\n  }\n}\nfunction ScriptComponent_po_list_view_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"po-list-view\", 20);\n    i0.ɵɵtemplate(1, ScriptComponent_po_list_view_7_ng_template_1_Template, 2, 4, \"ng-template\", 21);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵproperty(\"p-items\", ctx_r2.schedulesScriptProtheus)(\"p-actions\", ctx_r2.setListViewActions);\n  }\n}\nconst CNST_FIELD_NAMES = [{\n  key: 'scheduleId',\n  value: 'Nome do agendamento*'\n}, {\n  key: 'name',\n  value: 'Nome da rotina*'\n}, {\n  key: 'script',\n  value: 'Comando SQL*'\n}];\nlet ScriptComponent = /*#__PURE__*/(() => {\n  class ScriptComponent {\n    constructor(_workspaceService, _databaseService, _scriptService, _scheduleService, _electronService, _utilities) {\n      this._workspaceService = _workspaceService;\n      this._databaseService = _databaseService;\n      this._scriptService = _scriptService;\n      this._scheduleService = _scheduleService;\n      this._electronService = _electronService;\n      this._utilities = _utilities;\n      this.script = new interfaces_1.Script();\n      this.bkpScript = null;\n      this.modal_1_title = null;\n      this.listProjectExport = null;\n      this.listSchedule = null;\n      this.po_lo_text = {\n        value: null\n      };\n      this.schedulesScriptTotal = [];\n      this.schedulesScript = [];\n      this.schedulesScriptProtheus = [];\n      this.projectExport = null;\n      /*************************************************/\n      /*************************************************/\n      /*************************************************/\n      this.setTableRowActions = [{\n        label: 'Editar',\n        action: this.editScript.bind(this),\n        visible: s => s.canDecrypt\n      }, {\n        label: 'Excluir',\n        action: this.deleteScript.bind(this),\n        visible: true\n      }];\n      this.setListViewActions = [{\n        label: 'Importar rotinas FAST',\n        action: this.exportScript.bind(this),\n        visible: true\n      }];\n      this.setcolumns = [{\n        property: \"name\",\n        label: 'Nome da rotina',\n        type: 'string',\n        width: '20%',\n        sortable: true\n      }, {\n        property: \"script\",\n        label: 'Comando SQL',\n        type: 'string',\n        width: '80%',\n        sortable: false\n      }];\n      this._CNST_FIELD_NAMES = CNST_FIELD_NAMES;\n      this.lbl_schedule = this._CNST_FIELD_NAMES.find(v => {\n        return v.key == 'scheduleId';\n      }).value;\n      this.lbl_scriptName = this._CNST_FIELD_NAMES.find(v => {\n        return v.key == 'name';\n      }).value;\n      this.lbl_scriptQuery = this._CNST_FIELD_NAMES.find(v => {\n        return v.key == 'script';\n      }).value;\n    }\n    ngOnInit() {\n      this.loadScripts();\n      this.loadWorkspaces();\n    }\n    loadScripts() {\n      this.po_lo_text = {\n        value: script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_LOADING\n      };\n      (0, rxjs_1.forkJoin)([this._scheduleService.getSchedules(true), this._scriptService.getScripts(), this._workspaceService.getWorkspaces(), this._databaseService.getDatabases()]).subscribe(results => {\n        this.schedulesScriptTotal = results[0].map(s => {\n          s.schedule = s;\n          s.scripts = results[1].filter(script => s.id === script.scheduleId);\n          s.scripts.map(script => {\n            if (this._electronService.isElectronApp && script.canDecrypt) {\n              script.script = this._electronService.ipcRenderer.sendSync('decrypt', script.script);\n            }\n          });\n          let w = results[2].find(w => w.id == s.workspaceId);\n          s.erp = w.erp;\n          s.contractType = w.contractType;\n          s.module = w.module;\n          s.databaseType = results[3].find(db => db.id == w.databaseId).type;\n          if (s.databaseType.indexOf(_constants.CNST_DATABASE_ORACLE) > -1) s.databaseType = _constants.CNST_DATABASE_ORACLE;\n          return s;\n        });\n        this.schedulesScript = this.schedulesScriptTotal.filter(ss => !(ss.erp == _constants.CNST_ERP_PROTHEUS && ss.contractType == _constants.CNST_MODALIDADE_CONTRATACAO_PLATAFORMA));\n        this.schedulesScriptProtheus = this.schedulesScriptTotal.filter(ss => ss.erp == _constants.CNST_ERP_PROTHEUS && ss.contractType == _constants.CNST_MODALIDADE_CONTRATACAO_PLATAFORMA);\n        this.listSchedule = results[0].map(s => {\n          return {\n            label: s.name,\n            value: s.id\n          };\n        });\n        this.po_lo_text = {\n          value: null\n        };\n      }, err => {\n        this._utilities.createNotification(_constants.CNST_LOGLEVEL.ERROR, script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_LOADING_ERROR, err);\n        this.po_lo_text = {\n          value: null\n        };\n      });\n    }\n    loadWorkspaces() {\n      this.po_lo_text = {\n        value: script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_LOADING_PROJECTS\n      };\n      this._workspaceService.getWorkspaces().subscribe(workspaces => {\n        this.listProjectExport = workspaces.filter(w => {\n          return w.erp === _constants.CNST_ERP_PROTHEUS;\n        }).map(w => {\n          return {\n            label: w.name,\n            value: w.id\n          };\n        });\n        this.po_lo_text = {\n          value: null\n        };\n      }, err => {\n        this._utilities.createNotification(_constants.CNST_LOGLEVEL.ERROR, script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_LOADING_PROJECTS_ERROR, err);\n        this.po_lo_text = {\n          value: null\n        };\n      });\n    }\n    newScript() {\n      this.modal_1_title = 'Nova rotina';\n      this.script = new interfaces_1.Script();\n      this.script.canDecrypt = true;\n      this.modal_1.open();\n    }\n    editScript(script) {\n      this.modal_1_title = 'Editar rotina';\n      this.script = script;\n      this.bkpScript = script.script;\n      this.modal_1.open();\n    }\n    modal_1_close() {\n      this.bkpScript = null;\n      this.modal_1.close();\n    }\n    modal_1_confirm() {\n      if (this.validateScript()) {\n        this.modal_1.close();\n        this.po_lo_text = {\n          value: script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_SAVE(this.script.name)\n        };\n        if (this._electronService.isElectronApp) {\n          if (this.script.script != this.bkpScript) {\n            this._utilities.writeToLog(_constants.CNST_LOGLEVEL.DEBUG, script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_ENCRYPT(this.script.name));\n            this.po_lo_text = {\n              value: script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_ENCRYPT(this.script.name)\n            };\n            this.script.script = this._electronService.ipcRenderer.sendSync('encrypt', this.script.script);\n          }\n        }\n        this._scriptService.saveScript(this.script).subscribe(res => {\n          this.loadScripts();\n          this._utilities.createNotification(_constants.CNST_LOGLEVEL.INFO, script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_SAVE_OK);\n          this.po_lo_text = {\n            value: null\n          };\n        }, err => {\n          this._utilities.createNotification(_constants.CNST_LOGLEVEL.ERROR, script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_SAVE_ERROR(this.script.name), err);\n          this.po_lo_text = {\n            value: null\n          };\n        });\n      }\n    }\n    validateScript() {\n      this._utilities.writeToLog(_constants.CNST_LOGLEVEL.DEBUG, script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_VALIDATE);\n      this.po_lo_text = {\n        value: script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_VALIDATE\n      };\n      let script = new interfaces_1.Script();\n      let validate = true;\n      let propertiesNotDefined = Object.getOwnPropertyNames.call(Object, script).map(p => {\n        if (this.script[p] == undefined && p != 'id') return p;\n      }).filter(p => {\n        return p != null;\n      });\n      // Validação dos campos de formulário //\n      if (propertiesNotDefined.length > 0) {\n        this.po_lo_text = {\n          value: null\n        };\n        this._utilities.createNotification(_constants.CNST_LOGLEVEL.ERROR, 'Campo obrigatório \"' + this._CNST_FIELD_NAMES.find(f => {\n          return f.key === propertiesNotDefined[0];\n        }).value + '\" não preenchido.');\n        validate = false;\n      }\n      return validate;\n    }\n    deleteScript(script) {\n      this.scriptToDelete = script;\n      this.modal_2.open();\n    }\n    modal_2_close() {\n      this.scriptToDelete = null;\n      this.modal_2.close();\n    }\n    modal_2_confirm() {\n      this.modal_2.close();\n      this.po_lo_text = {\n        value: script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_DELETE\n      };\n      this._scriptService.deleteScript(this.scriptToDelete).subscribe(b => {\n        this.loadScripts();\n        this._utilities.createNotification(_constants.CNST_LOGLEVEL.INFO, script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_DELETE_OK);\n        this.po_lo_text = {\n          value: null\n        };\n      }, err => {\n        this._utilities.createNotification(_constants.CNST_LOGLEVEL.ERROR, script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_DELETE_ERROR, err);\n        this.po_lo_text = {\n          value: null\n        };\n      });\n    }\n    exportScript(ss) {\n      this.po_lo_text = {\n        value: script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_EXPORT\n      };\n      this._scriptService.exportScript(ss).subscribe(res => {\n        if (res) this.loadScripts();\n        this.po_lo_text = {\n          value: null\n        };\n      }, err => {\n        this._utilities.createNotification(_constants.CNST_LOGLEVEL.ERROR, script_messages_1.CNST_SCRIPT_MESSAGES.SCRIPT_EXPORT_ERROR, err);\n        this.po_lo_text = {\n          value: null\n        };\n      });\n    }\n  }\n  ScriptComponent.ɵfac = function ScriptComponent_Factory(t) {\n    return new (t || ScriptComponent)(i0.ɵɵdirectiveInject(i1.WorkspaceService), i0.ɵɵdirectiveInject(i2.DatabaseService), i0.ɵɵdirectiveInject(i3.ScriptService), i0.ɵɵdirectiveInject(i4.ScheduleService), i0.ɵɵdirectiveInject(i5.ElectronService), i0.ɵɵdirectiveInject(i6.Utilities));\n  };\n  ScriptComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: ScriptComponent,\n    selectors: [[\"app-script\"]],\n    viewQuery: function ScriptComponent_Query(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵviewQuery(_c0, 5);\n        i0.ɵɵviewQuery(_c1, 5);\n      }\n      if (rf & 2) {\n        let _t;\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.modal_1 = _t.first);\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.modal_2 = _t.first);\n      }\n    },\n    decls: 25,\n    vars: 17,\n    consts: [[\"p-title\", \"Cadastro de Rotinas (Scripts)\"], [1, \"po-row\"], [\"p-label\", \"Adicionar\", \"p-icon\", \"po-icon po-icon-plus\", \"p-kind\", \"primary\", 1, \"padding-button\", 3, \"p-click\"], [\"p-screen-lock\", \"true\", 3, \"hidden\", \"p-text\"], [\"class\", \"po-sm-12 po-md-12 po-lg-12 po-xl-12 list-project list-project-empty\", 4, \"ngIf\"], [\"p-property-title\", \"name\", 3, \"p-items\", \"p-actions\", 4, \"ngIf\"], [3, \"p-title\", \"p-primary-action\", \"p-secondary-action\"], [\"modal_1\", \"\"], [\"queryForm\", \"ngForm\"], [\"name\", \"po_schedule\", \"p-required\", \"true\", 1, \"po-sm-12\", \"po-md-12\", \"po-lg-12\", \"po-xl-12\", 3, \"p-label\", \"ngModel\", \"p-options\", \"ngModelChange\"], [\"name\", \"po_scriptName\", \"p-required\", \"true\", 1, \"po-sm-12\", \"po-md-12\", \"po-lg-12\", \"po-xl-12\", 3, \"p-label\", \"ngModel\", \"ngModelChange\"], [\"name\", \"po_scriptQuery\", \"p-rows\", \"10\", 1, \"po-textarea\", \"po-sm-12\", \"po-md-12\", \"po-lg-12\", \"po-xl-12\", \"script-text\", \"removeBorder\", \"padding-0\", \"textarea\", 3, \"p-label\", \"ngModel\", \"ngModelChange\"], [1, \"modal-footer\"], [1, \"po-row\", \"footer\"], [\"p-label\", \"Cancelar\", 3, \"p-click\"], [\"p-label\", \"Confirmar\", \"p-kind\", \"primary\", 3, \"p-click\"], [\"p-title\", \"Deseja realmente excluir esta rotina?\", 3, \"p-primary-action\", \"p-secondary-action\"], [\"modal_2\", \"\"], [\"p-label\", \"Remover\", \"p-kind\", \"primary\", 3, \"p-click\"], [1, \"po-sm-12\", \"po-md-12\", \"po-lg-12\", \"po-xl-12\", \"list-project\", \"list-project-empty\"], [\"p-property-title\", \"name\", 3, \"p-items\", \"p-actions\"], [\"p-list-view-content-template\", \"\"], [\"p-hide-detail\", \"true\", \"p-hide-select-all\", \"true\", \"p-hide-columns-manager\", \"true\", \"p-infinite-scroll\", \"true\", \"p-sort\", \"true\", 1, \"table\", 3, \"p-actions\", \"p-columns\", \"p-items\", \"p-actions-right\"]],\n    template: function ScriptComponent_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵelementStart(0, \"po-page-list\", 0)(1, \"div\", 1)(2, \"po-button\", 2);\n        i0.ɵɵlistener(\"p-click\", function ScriptComponent_Template_po_button_p_click_2_listener() {\n          return ctx.newScript();\n        });\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelement(3, \"po-loading-overlay\", 3);\n        i0.ɵɵtemplate(4, ScriptComponent_div_4_Template, 3, 0, \"div\", 4);\n        i0.ɵɵelementStart(5, \"div\", 1);\n        i0.ɵɵtemplate(6, ScriptComponent_po_list_view_6_Template, 2, 2, \"po-list-view\", 5);\n        i0.ɵɵtemplate(7, ScriptComponent_po_list_view_7_Template, 2, 2, \"po-list-view\", 5);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(8, \"po-modal\", 6, 7)(10, \"form\", 1, 8)(12, \"po-select\", 9);\n        i0.ɵɵlistener(\"ngModelChange\", function ScriptComponent_Template_po_select_ngModelChange_12_listener($event) {\n          return ctx.script.scheduleId = $event;\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(13, \"po-input\", 10);\n        i0.ɵɵlistener(\"ngModelChange\", function ScriptComponent_Template_po_input_ngModelChange_13_listener($event) {\n          return ctx.script.name = $event;\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(14, \"po-textarea\", 11);\n        i0.ɵɵlistener(\"ngModelChange\", function ScriptComponent_Template_po_textarea_ngModelChange_14_listener($event) {\n          return ctx.script.script = $event;\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(15, \"po-modal-footer\", 12)(16, \"div\", 13)(17, \"po-button\", 14);\n        i0.ɵɵlistener(\"p-click\", function ScriptComponent_Template_po_button_p_click_17_listener() {\n          return ctx.modal_1_close();\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(18, \"po-button\", 15);\n        i0.ɵɵlistener(\"p-click\", function ScriptComponent_Template_po_button_p_click_18_listener() {\n          return ctx.modal_1_confirm();\n        });\n        i0.ɵɵelementEnd()()()()();\n        i0.ɵɵelementStart(19, \"po-modal\", 16, 17)(21, \"po-modal-footer\", 12)(22, \"div\", 13)(23, \"po-button\", 14);\n        i0.ɵɵlistener(\"p-click\", function ScriptComponent_Template_po_button_p_click_23_listener() {\n          return ctx.modal_2_close();\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(24, \"po-button\", 18);\n        i0.ɵɵlistener(\"p-click\", function ScriptComponent_Template_po_button_p_click_24_listener() {\n          return ctx.modal_2_confirm();\n        });\n        i0.ɵɵelementEnd()()()()();\n      }\n      if (rf & 2) {\n        i0.ɵɵadvance(3);\n        i0.ɵɵproperty(\"hidden\", ctx.po_lo_text.value == null)(\"p-text\", ctx.po_lo_text.value);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", ctx.schedulesScriptTotal.length === 0);\n        i0.ɵɵadvance(2);\n        i0.ɵɵproperty(\"ngIf\", ctx.schedulesScript.length > 0);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", ctx.schedulesScriptProtheus.length > 0);\n        i0.ɵɵadvance(1);\n        i0.ɵɵpropertyInterpolate(\"p-title\", ctx.modal_1_title);\n        i0.ɵɵproperty(\"p-primary-action\", ctx.modal_1_confirm)(\"p-secondary-action\", ctx.modal_1_close);\n        i0.ɵɵadvance(4);\n        i0.ɵɵproperty(\"p-label\", ctx.lbl_schedule)(\"ngModel\", ctx.script.scheduleId)(\"p-options\", ctx.listSchedule);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"p-label\", ctx.lbl_scriptName)(\"ngModel\", ctx.script.name);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"p-label\", ctx.lbl_scriptQuery)(\"ngModel\", ctx.script.script);\n        i0.ɵɵadvance(5);\n        i0.ɵɵproperty(\"p-primary-action\", ctx.modal_2_confirm)(\"p-secondary-action\", ctx.modal_2_close);\n      }\n    },\n    dependencies: [i7.NgIf, i8.ɵNgNoValidate, i8.NgControlStatus, i8.NgControlStatusGroup, i8.NgModel, i8.NgForm, i9.PoListViewComponent, i9.PoListViewContentTemplateDirective, i9.PoButtonComponent, i9.PoPageListComponent, i9.PoTableComponent, i9.PoModalComponent, i9.PoModalFooterComponent, i9.PoInputComponent, i9.PoSelectComponent, i9.PoTextareaComponent, i9.PoLoadingOverlayComponent],\n    styles: [\".modal-footer[_ngcontent-%COMP%]{width:100%}.textarea[_ngcontent-%COMP%]{background:#FFFFFF}.footer[_ngcontent-%COMP%]{justify-content:right}.btn-new[_ngcontent-%COMP%]{margin-left:0%;width:130px}.btn-export[_ngcontent-%COMP%]{margin-right:0%;width:130px}.export[_ngcontent-%COMP%]{text-align:right}.script-text[_ngcontent-%COMP%]{margin:10px}.list-project-empty[_ngcontent-%COMP%]{text-align:center;background-color:#fff;border-top:2px solid #ceeaf2;margin-top:24px;line-height:50px;font-weight:700}\"]\n  });\n  return ScriptComponent;\n})();\nexports.ScriptComponent = ScriptComponent;","map":null,"metadata":{},"sourceType":"script","externalDependencies":[]}